# .github/workflows/parallel-500.yml
name: Parallel (500x)

on:
  push:
    branches: [ "test_matrix" ]

jobs:
  gen-matrices:
    runs-on: flow-runner-RqbKVQ9uMj5q
    outputs:
      first:  ${{ steps.out.outputs.first }}
      second: ${{ steps.out.outputs.second }}
    steps:
      - id: out
        shell: bash
        run: |
          mklist() { # mklist 0 249  -> 0,1,2,...,249
            awk -v s="$1" -v e="$2" 'BEGIN{for(i=s;i<=e;i++){printf i; if(i<e) printf ","}}'
          }
          first='{"shard":['"$(mklist 0 249)"']}'
          second='{"shard":['"$(mklist 250 499)"']}'
          {
            echo "first=$first"
            echo "second=$second"
          } >> "$GITHUB_OUTPUT"

  run-a:
    needs: gen-matrices
    runs-on: flow-runner-RqbKVQ9uMj5q
    strategy:
      fail-fast: false
      max-parallel: 250
      matrix: ${{ fromJSON(needs.gen-matrices.outputs.first) }}
    steps:
      - uses: actions/checkout@v4
      - run: echo "Hello World"
        env:
          SHARD_INDEX: ${{ matrix.shard }}
          SHARD_TOTAL: 500

  run-b:
    needs: gen-matrices
    runs-on: flow-runner-RqbKVQ9uMj5q
    strategy:
      fail-fast: false
      max-parallel: 250
      matrix: ${{ fromJSON(needs.gen-matrices.outputs.second) }}
    steps:
      - uses: actions/checkout@v4
      - run: echo "Hello World"
        env:
          SHARD_INDEX: ${{ matrix.shard }}
          SHARD_TOTAL: 500
